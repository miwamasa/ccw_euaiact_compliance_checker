<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EU AI法コンプライアンスチェッカー</title>
    <style>
        :root {
            --primary-color: #003399;
            --secondary-color: #ffcc00;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background-color: var(--light-bg);
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, var(--primary-color), #0066cc);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        header h1 { font-size: 1.8em; margin-bottom: 10px; }
        header p { opacity: 0.9; font-size: 0.95em; }
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .mode-tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }
        .mode-tab:hover { background: #e9ecef; }
        .mode-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .panel.active { display: block; }
        .question-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .question-number {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 1.15em;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 15px;
        }
        .question-info {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            border-left: 4px solid var(--info-color);
        }
        .options-list { list-style: none; }
        .option-item { margin-bottom: 10px; }
        .option-label {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-label:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }
        .option-label input {
            margin-right: 12px;
            margin-top: 3px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .option-text { flex: 1; }
        .btn {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #002266; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .result-card {
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .result-outofscope { background: #e9ecef; border: 2px solid #6c757d; }
        .result-excluded { background: #d1ecf1; border: 2px solid var(--info-color); }
        .result-prohibited { background: #f8d7da; border: 2px solid var(--danger-color); }
        .result-compliance { background: #d4edda; border: 2px solid var(--success-color); }
        .result-gpai { background: #fff3cd; border: 2px solid var(--warning-color); }
        .result-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .obligations-list {
            list-style: disc;
            padding-left: 25px;
            margin-top: 15px;
        }
        .obligations-list li { margin-bottom: 8px; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s;
        }
        .reverse-section { margin-bottom: 30px; }
        .reverse-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }
        .result-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .result-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 51, 153, 0.15);
        }
        .result-item.expanded { border-color: var(--primary-color); border-width: 2px; }
        .result-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-item-title { font-weight: 600; font-size: 1.05em; }
        .result-item-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .badge-high-risk { background: #fff3cd; color: #856404; }
        .badge-prohibited { background: #f8d7da; color: #721c24; }
        .badge-gpai { background: #d4edda; color: #155724; }
        .badge-transparency { background: #d1ecf1; color: #0c5460; }
        .result-item-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .result-item.expanded .result-item-details { display: block; }
        .path-list { list-style: none; padding: 0; }
        .path-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .path-number {
            width: 28px;
            height: 28px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .legal-ref {
            background: #f0f7ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
        }
        @media (max-width: 600px) {
            .mode-tabs { flex-direction: column; }
            .mode-tab { text-align: center; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; }
            header h1 { font-size: 1.4em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EU AI法コンプライアンスチェッカー</h1>
            <p>AI法(EU) 2024/1689 に基づく義務を判定するツール<br>
            <small>Source: EC Service Desk Compliance Checker</small></p>
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.85em;">
                <strong>最適化統計:</strong> 33質問 → 20質問 (39%削減) | 平均パス長: 8.6 | 分析パス数: 7,762
            </div>
        </header>

        <div class="mode-tabs">
            <button class="mode-tab active" onclick="switchMode('checker')">コンプライアンスチェック</button>
            <button class="mode-tab" onclick="switchMode('reverse')">逆引き（義務から条件を確認）</button>
        </div>

        <div id="checker-panel" class="panel active">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <div id="question-container"></div>
            <div id="result-container" style="display: none;"></div>
            <div class="button-group" id="button-group">
                <button class="btn btn-secondary" onclick="prevQuestion()" id="prev-btn" style="display: none;">前へ</button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn">次へ</button>
                <button class="btn btn-success" onclick="restart()" id="restart-btn" style="display: none;">最初からやり直す</button>
            </div>
        </div>

        <div id="reverse-panel" class="panel">
            <div class="reverse-section">
                <h3>分類結果から必要な条件を確認</h3>
                <p style="margin-bottom: 20px;">以下の結果カテゴリをクリックすると、その結果に至るために必要な条件が表示されます。</p>
                <div id="reverse-results"></div>
            </div>
        </div>
    </div>

    <script>
        // 最適化統計（optimization_engine.py から生成）
        const optimizationStats = {
            totalQuestions: 33,
            optimizedQuestions: 20,
            pathsAnalyzed: 7762,
            shortestPath: 2,
            longestPath: 12,
            averagePath: 8.60,
            medianPath: 8
        };

        // 質問データ（EC Service Deskルーティングに基づく + 最適化統計）
        const questions = {
            'Q1': {
                id: 'Q1',
                text: 'AIモデルとAIシステムのどちらをチェックしますか？',
                info: 'AIモデルはAIシステムの必須コンポーネントですが、単独ではAIシステムを構成しません。',
                type: 'radio',
                stats: { ig: 0.0248, termProb: 0.0 },
                options: [
                    { value: 0, label: 'AIモデル', next: 'QGPAI_1' },
                    { value: 1, label: 'AIシステム', next: 'QAIS_1' }
                ]
            },
            'QAIS_1': {
                id: 'QAIS_1',
                text: 'あなたのシステムはAI法の定義するAIシステムに該当しますか？',
                info: 'AIシステムとは、様々なレベルの自律性で動作するように設計された機械ベースのシステムで、予測、コンテンツ、推奨、または決定などの出力を生成するものです。',
                type: 'radio',
                stats: { ig: 0.0349, termProb: 0.0 },
                options: [
                    { value: 0, label: 'はい', next: 'QAIS_2' },
                    { value: 1, label: 'いいえ', terminal: true, result: 'out_of_scope' },
                    { value: 2, label: '不明', next: 'QAIS_1_1' }
                ]
            },
            'QAIS_1_1': {
                id: 'QAIS_1_1',
                text: 'あなたのAIシステムは以下の特性を持っていますか？',
                info: '該当するものをすべて選択してください。',
                type: 'checkbox',
                options: [
                    { value: 0, label: '機械ベースである' },
                    { value: 1, label: '様々なレベルの自律性で動作するよう設計されている' },
                    { value: 2, label: '導入後に適応性を示す可能性がある' },
                    { value: 3, label: '入力から推論して出力を生成する' },
                    { value: 4, label: '出力が物理的または仮想的な環境に影響を与える' },
                    { value: 5, label: '上記に該当しない', exclusive: true, terminal: true, result: 'out_of_scope' }
                ],
                next: 'QAIS_2'
            },
            'QAIS_2': {
                id: 'QAIS_2',
                text: 'あなたまたはあなたの組織は以下のどの役割に該当しますか？',
                info: '最も当てはまる役割を選択してください。',
                type: 'radio',
                options: [
                    { value: 0, label: 'プロバイダー（開発者/提供者）', next: 'QAIS_3', setFlags: ['provider'] },
                    { value: 1, label: 'デプロイヤー（利用者）', next: 'QAIS_2_1', setFlags: ['deployer'] },
                    { value: 2, label: 'インポーター（輸入者）', next: 'QAIS_2_1', setFlags: ['importer'] },
                    { value: 3, label: 'ディストリビューター（販売者）', next: 'QAIS_2_1', setFlags: ['distributor'] },
                    { value: 4, label: '認定代理人', next: 'QAIS_3', setFlags: ['authorised_rep'] },
                    { value: 5, label: '製品製造者', next: 'QAIS_2_2', setFlags: ['product_manufacturer'] },
                    { value: 6, label: '個人使用者', terminal: true, result: 'excluded' }
                ]
            },
            'QAIS_2_1': {
                id: 'QAIS_2_1',
                text: '以下のいずれかに該当しますか？',
                info: '該当するものをすべて選択してください。',
                type: 'checkbox',
                options: [
                    { value: 0, label: 'AIシステムに自社名または商標を付けている', setFlags: ['becomes_provider'] },
                    { value: 1, label: 'AIシステムに重大な変更を加えた', setFlags: ['becomes_provider'] },
                    { value: 2, label: 'AIシステムの意図された目的を変更した', setFlags: ['becomes_provider'] },
                    { value: 3, label: '上記に該当しない', exclusive: true }
                ],
                next: 'QAIS_3'
            },
            'QAIS_2_2': {
                id: 'QAIS_2_2',
                text: '製品にAIシステムが統合されていますか？',
                type: 'checkbox',
                options: [
                    { value: 0, label: 'AIシステムは自社名で市場に投入される', setFlags: ['becomes_provider'] },
                    { value: 1, label: 'AIシステムは自社名でサービスとして提供される', setFlags: ['becomes_provider'] },
                    { value: 2, label: '上記に該当しない', exclusive: true, terminal: true, result: 'out_of_scope' }
                ],
                next: 'QAIS_3'
            },
            'QAIS_3': {
                id: 'QAIS_3',
                text: '以下のいずれかに該当しますか？',
                info: 'EUとの関連性を確認します。',
                type: 'checkbox',
                options: [
                    { value: 0, label: 'AIシステムをEU市場に投入または提供している' },
                    { value: 1, label: 'EU内に拠点がある' },
                    { value: 2, label: 'AIシステムの出力がEU内で使用される' },
                    { value: 3, label: '製品にAIシステムが統合されEU市場に投入される' },
                    { value: 4, label: '上記に該当しない', exclusive: true, terminal: true, result: 'out_of_scope' }
                ],
                next: 'QAIS_4'
            },
            'QAIS_4': {
                id: 'QAIS_4',
                text: 'AIシステムは以下のいずれかに該当しますか？',
                info: '除外規定を確認します。',
                type: 'checkbox',
                options: [
                    { value: 0, label: '軍事・防衛目的のみで開発/使用', terminal: true, result: 'excluded' },
                    { value: 1, label: '第三国の公的機関による法執行目的', terminal: true, result: 'excluded' },
                    { value: 2, label: '科学研究・開発目的のみ', terminal: true, result: 'excluded' },
                    { value: 3, label: '市場投入前のテスト活動', terminal: true, result: 'excluded' },
                    { value: 4, label: '上記に該当しない', exclusive: true }
                ],
                next: 'QAIS_5'
            },
            'QAIS_5': {
                id: 'QAIS_5',
                text: 'AIシステムは以下の禁止されたAI実践に該当しますか？',
                info: '第5条により禁止されています。',
                type: 'checkbox',
                stats: { ig: 2.39, termProb: 0.615 },
                options: [
                    { value: 0, label: 'サブリミナル技術、操作、欺瞞的技術の使用', terminal: true, result: 'prohibited' },
                    { value: 1, label: '年齢、障害、社会経済的状況による脆弱性の悪用', terminal: true, result: 'prohibited' },
                    { value: 2, label: '公的機関によるソーシャルスコアリング', terminal: true, result: 'prohibited' },
                    { value: 3, label: '個人特性のみに基づく犯罪予測', terminal: true, result: 'prohibited' },
                    { value: 4, label: '無差別な顔認識データベースの構築', terminal: true, result: 'prohibited' },
                    { value: 5, label: '職場/教育機関での感情認識（医療/安全以外）', terminal: true, result: 'prohibited' },
                    { value: 6, label: '機密データ推測のための生体認証分類', terminal: true, result: 'prohibited' },
                    { value: 7, label: '公共空間でのリアルタイム遠隔生体認証', terminal: true, result: 'prohibited' },
                    { value: 8, label: '上記に該当しない', exclusive: true }
                ],
                next: 'QAIS_6'
            },
            'QAIS_6': {
                id: 'QAIS_6',
                text: 'あなたのAIシステム、または安全コンポーネントとして使用される製品は、分野固有の規制の対象ですか？',
                info: 'AI法では「安全コンポーネント」を「製品またはAIシステムの安全機能を果たすコンポーネント、またはその故障や誤動作が人や財産の健康・安全を危険にさらすもの」と定義しています（第3条(14)）',
                type: 'radio',
                stats: { ig: 3.7676, termProb: 0.0 },
                options: [
                    { value: 0, label: 'はい（分野固有の規制対象）', next: 'QAIS_6_1' },
                    { value: 1, label: 'いいえ', next: 'QAIS_6_4' },
                    { value: 2, label: '不明', next: 'QAIS_6_1' }
                ]
            },
            'QAIS_6_1': {
                id: 'QAIS_6_1',
                text: '以下のどの分野の規制対象ですか？',
                info: '附属書I Section A の製品安全法規制',
                type: 'checkbox',
                options: [
                    { value: 0, label: '機械' },
                    { value: 1, label: '玩具' },
                    { value: 2, label: 'レクリエーション用船舶' },
                    { value: 3, label: 'リフトおよび安全装置' },
                    { value: 4, label: '爆発性環境用機器' },
                    { value: 5, label: '無線機器' },
                    { value: 6, label: '圧力機器' },
                    { value: 7, label: '索道設備' },
                    { value: 8, label: '個人用保護具' },
                    { value: 9, label: 'ガス燃焼器具' },
                    { value: 10, label: '医療機器' },
                    { value: 11, label: '体外診断用医療機器' },
                    { value: 12, label: '上記に該当しない', exclusive: true }
                ],
                next: 'QAIS_6_2'
            },
            'QAIS_6_2': {
                id: 'QAIS_6_2',
                text: '製品またはAIシステムは第三者適合性評価が必要ですか？',
                type: 'radio',
                options: [
                    { value: 0, label: 'はい', setFlags: ['high_risk'] },
                    { value: 1, label: 'いいえ' }
                ],
                next: 'QAIS_6_4'
            },
            'QAIS_6_4': {
                id: 'QAIS_6_4',
                text: 'AIシステムは以下のどの分野に該当しますか？',
                info: '附属書III のハイリスク分野。いずれかに該当する場合、ハイリスクAIシステムの可能性があります。',
                type: 'checkbox',
                stats: { ig: 3.5, termProb: 0.0 },
                options: [
                    { value: 0, label: '生体認証・分類', setFlags: ['high_risk_candidate'] },
                    { value: 1, label: '重要インフラ管理', setFlags: ['high_risk_candidate'] },
                    { value: 2, label: '教育・職業訓練', setFlags: ['high_risk_candidate'] },
                    { value: 3, label: '雇用・人事管理', setFlags: ['high_risk_candidate'] },
                    { value: 4, label: '必須サービスへのアクセス', setFlags: ['high_risk_candidate'] },
                    { value: 5, label: '法執行', setFlags: ['high_risk_candidate'] },
                    { value: 6, label: '移民・国境管理', setFlags: ['high_risk_candidate'] },
                    { value: 7, label: '司法・民主的プロセス', setFlags: ['high_risk_candidate'] },
                    { value: 8, label: '上記に該当しない', exclusive: true, next: 'QAIS_7' }
                ],
                next: 'QAIS_6_5'
            },
            'QAIS_6_5': {
                id: 'QAIS_6_5',
                text: 'AIシステムはハイリスク分類から除外される可能性がありますか？',
                info: '第6条(3)の除外基準',
                type: 'checkbox',
                options: [
                    { value: 0, label: '狭い手続き的タスクのみを実行' },
                    { value: 1, label: '以前完了した人間の活動を改善するのみ' },
                    { value: 2, label: '人間の評価を代替しないパターン検出のみ' },
                    { value: 3, label: '意思決定の準備的タスクのみ' },
                    { value: 4, label: '上記に該当しない（またはプロファイリングを実行）', setFlags: ['high_risk'] }
                ],
                next: 'QAIS_7'
            },
            'QAIS_7': {
                id: 'QAIS_7',
                text: 'AIシステムは以下の機能を実行しますか？',
                info: '透明性義務（第50条）',
                type: 'checkbox',
                options: [
                    { value: 0, label: '人との直接的なインタラクション', setFlags: ['transparency_interact'] },
                    { value: 1, label: '合成コンテンツの生成', setFlags: ['transparency_synthetic'] },
                    { value: 2, label: '感情認識または生体認証分類', setFlags: ['transparency_emotion'] },
                    { value: 3, label: 'ディープフェイクの生成', setFlags: ['transparency_deepfake'] },
                    { value: 4, label: '上記に該当しない', exclusive: true }
                ],
                next: 'QAIS_8'
            },
            'QAIS_8': {
                id: 'QAIS_8',
                text: 'AIシステムはオープンソースライセンスでリリースされていますか？',
                type: 'radio',
                options: [
                    { value: 0, label: 'はい（非ハイリスク）', setFlags: ['open_source'] },
                    { value: 1, label: 'いいえ' }
                ],
                terminal: true,
                result: 'compliance_required'
            },
            // GPAI トラック（高情報利得）
            'QGPAI_1': {
                id: 'QGPAI_1',
                text: 'あなたのAIモデルはAI法の定義する汎用AIモデルに該当しますか？',
                info: '汎用AIモデル（GPAI）とは、大量のデータで訓練され、多様なタスクに使用可能な基盤モデルです。',
                type: 'radio',
                stats: { ig: 4.6432, termProb: 0.053 },
                options: [
                    { value: 0, label: 'はい', next: 'QGPAI_2' },
                    { value: 1, label: 'いいえ', terminal: true, result: 'not_gpai' }
                ]
            },
            'QGPAI_2': {
                id: 'QGPAI_2',
                text: '以下のどれに該当しますか？',
                info: 'システミックリスクの判定',
                type: 'checkbox',
                stats: { ig: 4.6455, termProb: 0.0 },
                options: [
                    { value: 0, label: '訓練に10^25 FLOP以上を使用', setFlags: ['gpai_systemic'] },
                    { value: 1, label: '欧州委員会によりシステミックリスクありと指定', setFlags: ['gpai_systemic'] },
                    { value: 2, label: '上記に該当しない', exclusive: true }
                ],
                next: 'QGPAI_3'
            },
            'QGPAI_3': {
                id: 'QGPAI_3',
                text: 'あなたの役割は？',
                type: 'radio',
                stats: { ig: 4.6469, termProb: 0.389 },
                options: [
                    { value: 0, label: 'GPAIモデルのプロバイダー', next: 'QGPAI_7', setFlags: ['gpai_provider'] },
                    { value: 1, label: '既存GPAIモデルを微調整', next: 'QGPAI_7', setFlags: ['gpai_provider'] },
                    { value: 2, label: '下流プロバイダー（変更あり）', next: 'QGPAI_3_1' },
                    { value: 3, label: '下流プロバイダー（変更なし）', terminal: true, result: 'gpai_downstream' }
                ]
            },
            'QGPAI_3_1': {
                id: 'QGPAI_3_1',
                text: 'あなたの変更により機能が大幅に変わりますか？',
                type: 'radio',
                stats: { ig: 4.6497, termProb: 0.714 },
                options: [
                    { value: 0, label: 'いいえ', next: 'QGPAI_7' },
                    { value: 1, label: 'はい', terminal: true, result: 'gpai_new_provider' }
                ]
            },
            'QGPAI_7': {
                id: 'QGPAI_7',
                text: 'GPAIモデルはオープンソース例外に該当しますか？',
                info: 'モデルパラメータが公開され、使用・変更・配布が自由に許可されている場合',
                type: 'radio',
                stats: { ig: 4.6496, termProb: 1.0 },
                options: [
                    { value: 0, label: 'はい（オープンソース）', terminal: true, result: 'gpai_opensource' },
                    { value: 1, label: 'いいえ', terminal: true, result: 'gpai_compliance' }
                ]
            }
        };

        // 逆引きデータ
        const reverseData = [
            {
                id: 'prohibited',
                title: '禁止AIシステム',
                badge: 'badge-prohibited',
                badgeText: '禁止',
                description: 'EU AI法第5条により禁止されているAIシステム',
                conditions: [
                    { step: 1, text: 'Q1: AIシステムを選択' },
                    { step: 2, text: 'QAIS 1: はい（AIシステムに該当）' },
                    { step: 3, text: 'QAIS 2-4: 適切な役割、EU関連あり、除外なし' },
                    { step: 4, text: 'QAIS 5: 禁止されたAI実践のいずれかに該当' }
                ],
                legalRef: '第5条'
            },
            {
                id: 'high_risk',
                title: 'ハイリスクAIシステム',
                badge: 'badge-high-risk',
                badgeText: 'ハイリスク',
                description: '厳格な義務が課されるハイリスクAIシステム',
                conditions: [
                    { step: 1, text: 'Q1 → QAIS 1-5: 禁止に該当しない' },
                    { step: 2, text: 'QAIS 6: 附属書I/IIIのカテゴリに該当' },
                    { step: 3, text: 'QAIS 6.2/6.5: 第三者適合性評価が必要、または除外基準を満たさない' }
                ],
                legalRef: '第6条、附属書I、附属書III'
            },
            {
                id: 'gpai',
                title: '汎用AIモデル（GPAI）',
                badge: 'badge-gpai',
                badgeText: 'GPAI',
                description: '汎用AIモデルのプロバイダーに課される義務',
                conditions: [
                    { step: 1, text: 'Q1: AIモデルを選択' },
                    { step: 2, text: 'QGPAI 1: はい（GPAIに該当）' },
                    { step: 3, text: 'QGPAI 2: システミックリスクの有無' },
                    { step: 4, text: 'QGPAI 3: プロバイダーまたは微調整者' }
                ],
                legalRef: '第53条、第55条'
            },
            {
                id: 'transparency',
                title: '透明性義務',
                badge: 'badge-transparency',
                badgeText: '透明性',
                description: '特定機能を持つAIシステムに課される透明性義務',
                conditions: [
                    { step: 1, text: 'QAIS 7で該当する機能を選択' }
                ],
                items: [
                    { function: '人との直接的インタラクション', obligation: 'AIとの対話であることの通知', article: '第50条(1)' },
                    { function: '合成コンテンツの生成', obligation: 'AI生成コンテンツのマーキング', article: '第50条(2)' },
                    { function: '感情認識/生体認証分類', obligation: '対象者への通知', article: '第50条(3)' },
                    { function: 'ディープフェイク生成', obligation: 'AI生成/操作コンテンツの開示', article: '第50条(4)' }
                ],
                legalRef: '第50条'
            }
        ];

        // 状態管理
        let currentQuestionId = 'Q1';
        let questionHistory = [];
        let answers = {};
        let flags = {};
        let questionCount = 0;

        function switchMode(mode) {
            document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            document.querySelector(`.mode-tab[onclick*="${mode}"]`).classList.add('active');
            document.getElementById(`${mode}-panel`).classList.add('active');
            if (mode === 'reverse') renderReversePanel();
        }

        function renderQuestion() {
            const q = questions[currentQuestionId];
            if (!q) {
                showResult('compliance_required');
                return;
            }

            questionCount++;
            updateProgress();

            const container = document.getElementById('question-container');
            const inputType = q.type === 'radio' ? 'radio' : 'checkbox';
            const savedAnswer = answers[q.id];

            let optionsHtml = q.options.map((opt, i) => {
                let checked = '';
                if (q.type === 'radio') {
                    checked = savedAnswer === opt.value ? 'checked' : '';
                } else {
                    checked = (savedAnswer || []).includes(opt.value) ? 'checked' : '';
                }
                return `
                    <li class="option-item">
                        <label class="option-label">
                            <input type="${inputType}" name="q_${q.id}" value="${opt.value}" ${checked}>
                            <span class="option-text">${opt.label}</span>
                        </label>
                    </li>
                `;
            }).join('');

            // 最適化統計の表示
            let statsHtml = '';
            if (q.stats) {
                const igColor = q.stats.ig > 2.0 ? '#28a745' : q.stats.ig > 0.5 ? '#ffc107' : '#6c757d';
                const termColor = q.stats.termProb > 0.5 ? '#dc3545' : q.stats.termProb > 0.2 ? '#ffc107' : '#17a2b8';
                statsHtml = `
                    <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 0.8em;">
                        <span style="background: ${igColor}20; color: ${igColor}; padding: 3px 8px; border-radius: 4px;">
                            IG: ${q.stats.ig.toFixed(2)}
                        </span>
                        <span style="background: ${termColor}20; color: ${termColor}; padding: 3px 8px; border-radius: 4px;">
                            終了率: ${(q.stats.termProb * 100).toFixed(0)}%
                        </span>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="question-card">
                    <span class="question-number">${q.id} (質問 ${questionCount})</span>
                    ${statsHtml}
                    <h2 class="question-text">${q.text}</h2>
                    ${q.info ? `<div class="question-info">${q.info}</div>` : ''}
                    <ul class="options-list">${optionsHtml}</ul>
                </div>
            `;

            document.getElementById('prev-btn').style.display = questionHistory.length > 0 ? 'inline-block' : 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            document.getElementById('restart-btn').style.display = 'none';
            document.getElementById('result-container').style.display = 'none';
        }

        function updateProgress() {
            const maxQuestions = 14;
            const progress = Math.min((questionCount / maxQuestions) * 100, 100);
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function saveAnswer() {
            const q = questions[currentQuestionId];
            if (!q) return null;

            const inputs = document.querySelectorAll(`input[name="q_${q.id}"]:checked`);
            if (inputs.length === 0) return null;

            let result = null;
            let nextQuestion = null;

            if (q.type === 'radio') {
                const value = parseInt(inputs[0].value);
                answers[q.id] = value;
                const opt = q.options.find(o => o.value === value);
                if (opt) {
                    if (opt.setFlags) opt.setFlags.forEach(f => flags[f] = true);
                    if (opt.terminal) result = opt.result;
                    else if (opt.next) nextQuestion = opt.next;
                    else if (q.next) nextQuestion = q.next;
                }
            } else {
                const values = Array.from(inputs).map(i => parseInt(i.value));
                answers[q.id] = values;

                for (const value of values) {
                    const opt = q.options.find(o => o.value === value);
                    if (opt) {
                        if (opt.setFlags) opt.setFlags.forEach(f => flags[f] = true);
                        if (opt.terminal) {
                            result = opt.result;
                            break;
                        }
                        if (opt.next && !nextQuestion) nextQuestion = opt.next;
                    }
                }
                if (!result && !nextQuestion && q.next) nextQuestion = q.next;
            }

            if (q.terminal && !result) result = q.result;

            return { result, nextQuestion };
        }

        function nextQuestion() {
            const outcome = saveAnswer();
            if (!outcome) {
                alert('選択してください');
                return;
            }

            if (outcome.result) {
                showResult(outcome.result);
                return;
            }

            questionHistory.push(currentQuestionId);
            currentQuestionId = outcome.nextQuestion;
            renderQuestion();
        }

        function prevQuestion() {
            if (questionHistory.length > 0) {
                currentQuestionId = questionHistory.pop();
                questionCount--;
                renderQuestion();
            }
        }

        function showResult(resultType) {
            document.getElementById('question-container').innerHTML = '';
            document.getElementById('prev-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('restart-btn').style.display = 'inline-block';
            document.getElementById('progress-fill').style.width = '100%';

            const resultContainer = document.getElementById('result-container');
            resultContainer.style.display = 'block';

            let resultClass, resultTitle, resultDesc, obligationsList = [];

            switch (resultType) {
                case 'out_of_scope':
                    resultClass = 'result-outofscope';
                    resultTitle = '適用範囲外';
                    resultDesc = 'あなたのシステムはEU AI法の適用範囲外と考えられます。';
                    break;
                case 'excluded':
                    resultClass = 'result-excluded';
                    resultTitle = '適用除外';
                    resultDesc = 'あなたのシステムはEU AI法の除外規定に該当します。';
                    break;
                case 'prohibited':
                    resultClass = 'result-prohibited';
                    resultTitle = '禁止';
                    resultDesc = 'あなたのシステムは第5条により禁止されている機能を含んでいます。EU市場に投入できません。';
                    break;
                case 'not_gpai':
                    resultClass = 'result-outofscope';
                    resultTitle = 'GPAI非該当';
                    resultDesc = 'あなたのAIモデルは汎用AIモデルの定義に該当しません。';
                    break;
                case 'gpai_downstream':
                    resultClass = 'result-excluded';
                    resultTitle = 'GPAI下流プロバイダー';
                    resultDesc = '変更を加えていない下流プロバイダーとして、限定的な義務が適用されます。';
                    break;
                case 'gpai_opensource':
                    resultClass = 'result-gpai';
                    resultTitle = 'GPAIオープンソース';
                    resultDesc = 'オープンソース例外が適用されますが、一部の義務は残ります。';
                    obligationsList = ['技術文書の公開', 'EU著作権法の遵守'];
                    break;
                case 'gpai_compliance':
                case 'gpai_new_provider':
                    resultClass = 'result-gpai';
                    resultTitle = 'GPAIコンプライアンス必要';
                    resultDesc = flags.gpai_systemic
                        ? 'システミックリスクを持つGPAIモデルとして、追加義務が適用されます。'
                        : 'GPAIモデルプロバイダーとして義務が適用されます。';
                    obligationsList = ['技術文書の作成・維持', 'EU著作権法の遵守', '訓練データの概要公開'];
                    if (flags.gpai_systemic) {
                        obligationsList.push('モデル評価の実施', 'システミックリスクの評価・軽減', 'インシデント報告');
                    }
                    break;
                default:
                    resultClass = 'result-compliance';
                    resultTitle = 'コンプライアンス対応が必要';
                    resultDesc = `${questionCount}問の質問に回答しました。以下の義務が適用される可能性があります。`;

                    if (flags.provider || flags.deployer || flags.becomes_provider) {
                        obligationsList.push('AIリテラシー（第4条）');
                    }
                    if (flags.high_risk) {
                        if (flags.provider || flags.becomes_provider) {
                            obligationsList.push('ハイリスクAIプロバイダー義務（第16条）');
                        }
                        if (flags.deployer) {
                            obligationsList.push('ハイリスクAIデプロイヤー義務（第26条）');
                        }
                    }
                    if (flags.transparency_interact) obligationsList.push('透明性：AIとの対話通知（第50条(1)）');
                    if (flags.transparency_synthetic) obligationsList.push('透明性：合成コンテンツマーキング（第50条(2)）');
                    if (flags.transparency_emotion) obligationsList.push('透明性：感情認識通知（第50条(3)）');
                    if (flags.transparency_deepfake) obligationsList.push('透明性：ディープフェイク開示（第50条(4)）');
            }

            let obligationsHtml = obligationsList.length > 0 ? `
                <h4 style="margin-top: 20px; margin-bottom: 10px;">適用される義務:</h4>
                <ul class="obligations-list">
                    ${obligationsList.map(ob => `<li>${ob}</li>`).join('')}
                </ul>
            ` : '';

            resultContainer.innerHTML = `
                <div class="result-card ${resultClass}">
                    <h3 class="result-title">${resultTitle}</h3>
                    <p>${resultDesc}</p>
                    ${obligationsHtml}
                    <div class="legal-ref" style="margin-top: 20px;">
                        <strong>質問数:</strong> ${questionCount}問<br>
                        <strong>参考:</strong> EU AI法 (規則 (EU) 2024/1689)
                    </div>
                </div>
            `;
        }

        function restart() {
            currentQuestionId = 'Q1';
            questionHistory = [];
            answers = {};
            flags = {};
            questionCount = 0;
            renderQuestion();
        }

        function renderReversePanel() {
            const container = document.getElementById('reverse-results');
            container.innerHTML = reverseData.map(item => `
                <div class="result-item" onclick="this.classList.toggle('expanded')">
                    <div class="result-item-header">
                        <span class="result-item-title">${item.title}</span>
                        <span class="result-item-badge ${item.badge}">${item.badgeText}</span>
                    </div>
                    <div class="result-item-details">
                        <p style="margin-bottom: 15px;">${item.description}</p>
                        <h4 style="margin-bottom: 10px;">この結果に至る条件:</h4>
                        <ul class="path-list">
                            ${item.conditions.map(c => `
                                <li class="path-item">
                                    <span class="path-number">${c.step}</span>
                                    <span>${c.text}</span>
                                </li>
                            `).join('')}
                        </ul>
                        ${item.items ? `
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead><tr style="background: #f0f0f0;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">機能</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">義務</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">条文</th>
                                </tr></thead>
                                <tbody>${item.items.map(i => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${i.function}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${i.obligation}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${i.article}</td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        ` : ''}
                        <div class="legal-ref"><strong>関連条文:</strong> ${item.legalRef}</div>
                    </div>
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', () => renderQuestion());
    </script>
</body>
</html>
